<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two Hearts, One Qibla: Tahir & Khatija's 2026 Umrah</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a5f7a;
            --secondary-color: #57c5b6;
            --accent-color: #159895;
            --light-color: #f9f9f9;
            --gold-color: #d4af37;
            --love-color: #e83f6f;
            --text-color: #333;
        }
        
        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.8;
            color: var(--text-color);
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f5f0;
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
            opacity: 0;
            animation: fadeIn 0.5s ease-in forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            padding: 30px 20px;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 5px solid var(--love-color);
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><text x="10" y="50" font-family="Arial" font-size="40" fill="rgba(255,255,255,0.05)">ﷲ</text></svg>');
            opacity: 0.3;
        }
        
        h1 {
            margin: 0;
            font-size: 2.3em;
            font-weight: 300;
            position: relative;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            letter-spacing: 0.5px;
        }
        
        h1 .hearts {
            color: var(--love-color);
            margin: 0 5px;
            font-size: 1.2em;
        }
        
        h1::after {
            content: "";
            display: block;
            width: 150px;
            height: 3px;
            background: linear-gradient(to right, var(--love-color), var(--gold-color));
            margin: 15px auto;
            border-radius: 3px;
        }
        
        .subtitle {
            font-style: italic;
            margin-top: 10px;
            font-weight: 300;
            letter-spacing: 0.3px;
            font-size: 1.1em;
        }
        
        .qibla-arabic {
            font-family: 'Traditional Arabic', Arial;
            font-size: 1.1em;
            color: var(--gold-color);
        }
        
        .progress-container {
            background-color: #e0e0e0;
            border-radius: 20px;
            height: 30px;
            margin: 30px 0;
            width: 100%;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
            border-radius: 20px;
            height: 100%;
            width: 0%;
            transition: width 0.5s ease-out;
            text-align: center;
            line-height: 30px;
            color: white;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.15) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.15) 50%,
                rgba(255, 255, 255, 0.15) 75%,
                transparent 75%,
                transparent
            );
            background-size: 40px 40px;
            animation: progressStripes 2s linear infinite;
        }
        
        @keyframes progressStripes {
            0% { background-position: 0 0; }
            100% { background-position: 40px 0; }
        }
        
        .savings-form {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            position: relative;
        }
        
        .savings-form::before {
            content: "";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            top: -15px;
            right: 20px;
            font-size: 40px;
            color: rgba(23, 107, 135, 0.1);
            z-index: 0;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary-color);
        }
        
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input[type="number"]:focus, input[type="text"]:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(21, 152, 149, 0.2);
        }
        
        button {
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
        }
        
        button i {
            margin-right: 8px;
        }
        
        .expense-category {
            background-color: white;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            overflow: hidden;
        }
        
        .expense-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 20px;
            background-color: #f9f9f9;
            transition: background-color 0.3s;
        }
        
        .expense-header:hover {
            background-color: #f0f0f0;
        }
        
        .expense-details {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease;
        }
        
        .expense-details.show {
            padding: 20px;
            max-height: 1000px;
            border-top: 1px solid #eee;
        }
        
        .total-display {
            font-size: 1.4em;
            font-weight: bold;
            text-align: center;
            margin: 30px 0;
            color: var(--primary-color);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            border-left: 5px solid var(--gold-color);
        }
        
        .suggested-amount {
            background-color: #f0f7f6;
            padding: 25px;
            border-radius: 8px;
            margin: 30px 0;
            border-left: 5px solid var(--accent-color);
            position: relative;
        }
        
        .suggested-amount::before {
            content: "";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 40px;
            color: rgba(21, 152, 149, 0.1);
        }
        
        .notes {
            font-style: italic;
            color: #666;
            font-size: 0.9em;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 400;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f0f0f0;
        }
        
        .zar {
            font-weight: bold;
            color: var(--primary-color);
            font-family: 'Courier New', monospace;
        }
        
        .editable-cost {
            background-color: #fff8e1;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ffd54f;
            font-weight: bold;
            color: var(--primary-color);
            width: 120px;
            text-align: center;
        }
        
        .itinerary {
            background-color: #f0f7f6;
            padding: 25px;
            border-radius: 8px;
            margin: 30px 0;
            border-left: 5px solid var(--secondary-color);
            position: relative;
        }
        
        .itinerary::before {
            content: "";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 40px;
            color: rgba(87, 197, 182, 0.1);
        }
        
        .budget-tip {
            background-color: #fff8e1;
            padding: 15px;
            border-left: 4px solid var(--gold-color);
            margin: 15px 0;
            border-radius: 0 4px 4px 0;
            position: relative;
        }
        
        .budget-tip::before {
            content: "";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            left: 10px;
            top: 15px;
            color: var(--gold-color);
        }
        
        .budget-tip strong {
            margin-left: 25px;
        }
        
        .islamic-pattern {
            height: 20px;
            background-color: var(--primary-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="%23159895" d="M50 0L100 50L50 100L0 50Z"></path></svg>');
            background-size: 20px 20px;
            margin: 40px 0;
            opacity: 0.7;
            border-radius: 10px;
        }
        
        .supplication {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 30px 0;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            text-align: center;
            font-style: italic;
            border-right: 5px solid var(--gold-color);
            position: relative;
        }
        
        .supplication::before, .supplication::after {
            content: "";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            color: var(--gold-color);
            position: absolute;
            font-size: 20px;
        }
        
        .supplication::before {
            top: 10px;
            left: 10px;
        }
        
        .supplication::after {
            bottom: 10px;
            right: 10px;
            transform: rotate(180deg);
        }
        
        .islamic-icon {
            color: var(--gold-color);
            margin-right: 8px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .couple-icon {
            display: inline-block;
            margin: 0 5px;
            color: var(--love-color);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            .subtitle {
                font-size: 1em;
            }
            .expense-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .editable-cost {
                width: 100%;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>
            Two <span class="hearts">♥</span> Hearts<br>
            One <span class="qibla-arabic">قبلة</span>
        </h1>
        <div class="subtitle">Tahir <span class="couple-icon"><i class="fas fa-heart"></i></span> Khatija's 2026 Umrah Journey</div>
    </header>
    
    <div class="supplication">
        <p>"Our Lord! Accept from us this service. Indeed, You are the All-Hearing, the All-Knowing."</p>
        <p>(Quran 2:127)</p>
    </div>
    
    <div class="progress-container">
        <div class="progress-bar" id="progressBar">0%</div>
    </div>
    
    <div class="savings-form">
        <h2><i class="fas fa-piggy-bank islamic-icon"></i> Savings Tracker</h2>
        <div class="form-group">
            <label for="currentSavings"><i class="fas fa-wallet islamic-icon"></i> Current Savings Amount (<span class="zar">ZAR</span>):</label>
            <input type="number" id="currentSavings" min="0" step="1000" placeholder="Enter amount saved">
        </div>
        <div class="form-group">
            <label for="targetAmount"><i class="fas fa-bullseye islamic-icon"></i> Target Amount (<span class="zar">ZAR</span>):</label>
            <input type="number" id="targetAmount" min="0" step="1000" value="45000">
        </div>
        <button id="updateProgressBtn"><i class="fas fa-sync-alt"></i> Update Progress</button>
    </div>
    
    <div class="islamic-pattern"></div>
    
    <div class="suggested-amount">
        <h2><i class="fas fa-calendar-check islamic-icon"></i> Suggested Savings Plan</h2>
        <p>Based on a target of <span class="zar">R45,000</span> by November 2026 (30 months):</p>
        <ul>
            <li><strong><i class="fas fa-calendar-alt islamic-icon"></i> Monthly savings:</strong> <span class="zar">R1,500</span></li>
            <li><strong><i class="fas fa-calendar-week islamic-icon"></i> Weekly savings:</strong> <span class="zar">R346</span></li>
            <li><strong><i class="fas fa-sun islamic-icon"></i> Daily savings:</strong> <span class="zar">R50</span></li>
        </ul>
        <p class="notes">"And whoever fears Allah - He will make for him a way out and provide for him from where he does not expect." (Quran 65:2-3)</p>
    </div>
    
    <div class="islamic-pattern"></div>
    
    <div class="itinerary">
        <h2><i class="fas fa-route islamic-icon"></i> 6-Day Spiritual Journey</h2>
        <table>
            <tr>
                <th><i class="fas fa-calendar-day"></i> Day</th>
                <th><i class="fas fa-praying-hands"></i> Activities</th>
                <th><i class="fas fa-lightbulb"></i> Budget Tips</th>
            </tr>
            <tr>
                <td>Day 1</td>
                <td>Fly DUR-DXB-JED (overnight flight)</td>
                <td>Perform Ghusl before departure, pack meals for flight</td>
            </tr>
            <tr>
                <td>Day 2</td>
                <td>Arrive Jeddah, transfer to Makkah (4 nights)</td>
                <td>Recite Talbiyah during the journey</td>
            </tr>
            <tr>
                <td>Days 3-5</td>
                <td>Umrah rituals, prayers at Haram</td>
                <td>Focus on worship between prayers</td>
            </tr>
            <tr>
                <td>Day 6</td>
                <td>Morning in Makkah, afternoon flight back</td>
                <td>Make final dua at the Kaaba before departure</td>
            </tr>
        </table>
        <p class="notes">This blessed journey is designed to maximize spiritual benefit while maintaining a modest budget.</p>
    </div>
    
    <div class="islamic-pattern"></div>
    
    <h2><i class="fas fa-coins islamic-icon"></i> Budget Expense Breakdown</h2>
    <p>All amounts are in South African Rand (ZAR) for two people:</p>
    
    <div class="expense-category">
        <div class="expense-header" id="flightsHeader">
            <h3><i class="fas fa-plane islamic-icon"></i> Flights (Durban → Dubai → Jeddah)</h3>
            <span>Total: <input type="number" class="editable-cost" id="flightCost" value="22000" min="0" step="1000"></span>
        </div>
        <div class="expense-details" id="flightsDetails">
            <div class="budget-tip">
                <strong>Travel Wisdom:</strong> The Prophet (ﷺ) said: "The two feet of the son of Adam will not move from near his Lord on the Day of Judgement until he is asked about five matters..." including how he spent his wealth.
            </div>
            <ul>
                <li><i class="fas fa-check-circle"></i> Economy class return: <span class="zar">R11,000</span> pp (book during Emirates sales)</li>
                <li><i class="fas fa-check-circle"></i> Include: 30kg baggage allowance (share luggage)</li>
                <li><i class="fas fa-times-circle"></i> Exclude: Seat selection fees (accept allocation)</li>
            </ul>
        </div>
    </div>
    
    <div class="expense-category">
        <div class="expense-header" id="accommodationHeader">
            <h3><i class="fas fa-hotel islamic-icon"></i> Accommodation (5 nights)</h3>
            <span>Total: <input type="number" class="editable-cost" id="accomCost" value="7500" min="0" step="100"></span>
        </div>
        <div class="expense-details" id="accommodationDetails">
            <div class="budget-tip">
                <strong>Prophetic Guidance:</strong> The Prophet (ﷺ) lived simply. Focus on the spiritual experience rather than luxury accommodations.
            </div>
            <table>
                <tr>
                    <th>Location</th>
                    <th>Nights</th>
                    <th>Budget</th>
                    <th>Total</th>
                </tr>
                <tr>
                    <td>Makkah (Modest hotel)</td>
                    <td>4</td>
                    <td><span class="zar">R1,500</span>/night</td>
                    <td><span class="zar">R6,000</span></td>
                </tr>
                <tr>
                    <td>Jeddah (Airport hotel)</td>
                    <td>1</td>
                    <td><span class="zar">R1,500</span>/night</td>
                    <td><span class="zar">R1,500</span></td>
                </tr>
            </table>
        </div>
    </div>
    
    <div class="expense-category">
        <div class="expense-header" id="visaHeader">
            <h3><i class="fas fa-passport islamic-icon"></i> Visa & Admin Costs</h3>
            <span>Total: <input type="number" class="editable-cost" id="visaCost" value="8000" min="0" step="100"></span>
        </div>
        <div class="expense-details" id="visaDetails">
            <ul>
                <li><i class="fas fa-file-alt"></i> Umrah visa: <span class="zar">R3,500</span> pp (through approved agent)</li>
                <li><i class="fas fa-shield-alt"></i> Travel insurance: <span class="zar">R500</span> pp (basic coverage)</li>
                <li><i class="fas fa-syringe"></i> Vaccinations: <span class="zar">R500</span> pp (meningitis only)</li>
            </ul>
        </div>
    </div>
    
    <div class="expense-category">
        <div class="expense-header" id="foodHeader">
            <h3><i class="fas fa-utensils islamic-icon"></i> Food & Water (6 days)</h3>
            <span>Total: <input type="number" class="editable-cost" id="foodCost" value="3000" min="0" step="100"></span>
        </div>
        <div class="expense-details" id="foodDetails">
            <div class="budget-tip">
                <strong>Islamic Etiquette:</strong> The Prophet (ﷺ) said: "The son of Adam does not fill any vessel worse than his stomach. It is sufficient for the son of Adam to eat a few mouthfuls..."
            </div>
            <ul>
                <li><i class="fas fa-bread-slice"></i> Breakfast: <span class="zar">R100</span> pp/day (dates, bread, labneh)</li>
                <li><i class="fas fa-drumstick-bite"></i> Lunch/Dinner: <span class="zar">R200</span> pp/day (local restaurants)</li>
                <li><i class="fas fa-tint"></i> Water/Snacks: <span class="zar">R50</span> pp/day</li>
            </ul>
        </div>
    </div>
    
    <div class="expense-category">
        <div class="expense-header" id="transportHeader">
            <h3><i class="fas fa-car islamic-icon"></i> Transportation</h3>
            <span>Total: <input type="number" class="editable-cost" id="transportCost" value="4000" min="0" step="100"></span>
        </div>
        <div class="expense-details" id="transportDetails">
            <div class="budget-tip">
                <strong>Spiritual Benefit:</strong> Walking to the Haram brings more reward. The Prophet (ﷺ) said: "Every step taken toward the mosque is charity."
            </div>
            <ul>
                <li><i class="fas fa-shuttle-van"></i> Jeddah Airport to Makkah: <span class="zar">R1,000</span> (shared shuttle)</li>
                <li><i class="fas fa-shuttle-van"></i> Makkah to Jeddah Airport: <span class="zar">R1,000</span> (shared shuttle)</li>
                <li><i class="fas fa-taxi"></i> Local taxis: <span class="zar">R2,000</span> (emergency only)</li>
            </ul>
        </div>
    </div>
    
    <div class="expense-category">
        <div class="expense-header" id="zakatHeader">
            <h3><i class="fas fa-hand-holding-heart islamic-icon"></i> Zakat & Sadaqah</h3>
            <span>Total: <input type="number" class="editable-cost" id="zakatCost" value="1000" min="0" step="100"></span>
        </div>
        <div class="expense-details" id="zakatDetails">
            <div class="budget-tip">
                <strong>Divine Promise:</strong> "The example of those who spend their wealth in the way of Allah is like a seed that grows seven spikes; in each spike is a hundred grains." (Quran 2:261)
            </div>
            <p>Budget for charitable giving according to your means during this blessed journey.</p>
        </div>
    </div>
    
    <div class="expense-category">
        <div class="expense-header" id="miscHeader">
            <h3><i class="fas fa-random islamic-icon"></i> Miscellaneous</h3>
            <span>Total: <input type="number" class="editable-cost" id="miscCost" value="2500" min="0" step="100"></span>
        </div>
        <div class="expense-details" id="miscDetails">
            <ul>
                <li><i class="fas fa-sim-card"></i> SIM card with data: <span class="zar">R300</span></li>
                <li><i class="fas fa-gift"></i> Basic shopping (dates, small gifts): <span class="zar">R1,500</span></li>
                <li><i class="fas fa-first-aid"></i> Emergency fund: <span class="zar">R700</span></li>
            </ul>
        </div>
    </div>
    
    <div class="total-display">
        Estimated Total Cost for Two People: <span class="zar" id="totalCost">R45,000</span>
        <button id="calculateTotalBtn"><i class="fas fa-calculator"></i> Update Total</button>
    </div>
    
    <div class="islamic-pattern"></div>
    
    <div class="supplication">
        <p>"Our Lord! Grant us good in this world and good in the Hereafter, and protect us from the punishment of the Fire."</p>
        <p>(Quran 2:201)</p>
    </div>

    <script>
        // JSONBin.io Configuration
        const BIN_ID = '687204bb6063391d31abf1a8';
        const API_KEY = '$2a$10$badKixBj7UPzi9lf6pBspuEWXuy09HysK5V4pR1DSFGuJRR6Jkhkm';
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        // Default data structure
        const DEFAULT_DATA = {
            "tripDetails": {
                "title": "Two Hearts, One Qibla: Tahir & Khatija's 2026 Umrah",
                "year": 2026,
                "month": "November",
                "duration": 6,
                "route": "Durban → Dubai → Jeddah",
                "currency": "ZAR",
                "targetAmount": 45000,
                "currentSavings": 0,
                "lastUpdated": new Date().toISOString()
            },
            "expenseCategories": [
                {
                    "id": "flights",
                    "name": "Flights",
                    "budget": 22000,
                    "notes": "Economy class return via Emirates"
                },
                {
                    "id": "accommodation",
                    "name": "Accommodation",
                    "budget": 7500,
                    "notes": "5 nights total"
                },
                {
                    "id": "visa",
                    "name": "Visa & Admin",
                    "budget": 8000,
                    "notes": "Includes visas and insurance"
                },
                {
                    "id": "food",
                    "name": "Food & Water",
                    "budget": 3000,
                    "notes": "Simple meals"
                },
                {
                    "id": "transport",
                    "name": "Transportation",
                    "budget": 4000,
                    "notes": "Shared shuttles"
                },
                {
                    "id": "zakat",
                    "name": "Zakat & Sadaqah",
                    "budget": 1000,
                    "notes": "Charitable giving"
                },
                {
                    "id": "misc",
                    "name": "Miscellaneous",
                    "budget": 2500,
                    "notes": "SIM card, gifts"
                }
            ]
        };

        // DOM Elements
        const elements = {
            currentSavings: document.getElementById('currentSavings'),
            targetAmount: document.getElementById('targetAmount'),
            progressBar: document.getElementById('progressBar'),
            totalCost: document.getElementById('totalCost'),
            updateProgressBtn: document.getElementById('updateProgressBtn'),
            calculateTotalBtn: document.getElementById('calculateTotalBtn'),
            expenseInputs: document.querySelectorAll('.editable-cost')
        };

        // State management
        let appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
        let isLoading = false;

        // Load data from JSONBin.io
        async function loadData() {
            try {
                isLoading = true;
                toggleLoadingState(true);
                
                const response = await fetch(API_URL, {
                    headers: {
                        'X-Master-Key': API_KEY,
                        'X-Bin-Meta': 'false'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load data');
                }
                
                const data = await response.json();
                if (data && data.tripDetails) {
                    return data;
                }
                throw new Error('Invalid data structure');
            } catch (error) {
                console.warn('Using default data due to loading error:', error);
                
                // Check localStorage for backup
                const backup = localStorage.getItem('umrahBudgetBackup');
                if (backup) {
                    try {
                        return JSON.parse(backup);
                    } catch (e) {
                        console.warn('Failed to parse backup data:', e);
                    }
                }
                
                return JSON.parse(JSON.stringify(DEFAULT_DATA));
            } finally {
                isLoading = false;
                toggleLoadingState(false);
            }
        }

        // Save data to JSONBin.io
        async function saveData(data) {
            try {
                isLoading = true;
                toggleLoadingState(true);
                
                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save data');
                }
                
                // Update local copy
                appData = JSON.parse(JSON.stringify(data));
                appData.tripDetails.lastUpdated = new Date().toISOString();
                
                // Create backup in localStorage
                localStorage.setItem('umrahBudgetBackup', JSON.stringify(appData));
                
                return await response.json();
            } catch (error) {
                console.error('Error saving data:', error);
                return null;
            } finally {
                isLoading = false;
                toggleLoadingState(false);
            }
        }

        // Toggle loading state
        function toggleLoadingState(isLoading) {
            const buttons = [elements.updateProgressBtn, elements.calculateTotalBtn];
            
            buttons.forEach(button => {
                if (isLoading) {
                    button.disabled = true;
                    button.innerHTML = `<span class="loading"></span>${button.innerHTML}`;
                } else {
                    button.disabled = false;
                    button.querySelector('.loading')?.remove();
                }
            });
        }

        // Update the UI with current data
        function updateUI(data) {
            // Trip details
            elements.currentSavings.value = data.tripDetails.currentSavings;
            elements.targetAmount.value = data.tripDetails.targetAmount;
            
            // Expense categories
            data.expenseCategories.forEach(category => {
                const input = document.getElementById(`${category.id}Cost`);
                if (input) input.value = category.budget;
            });
            
            // Calculate and update totals
            calculateTotal();
        }

        // Set up all event listeners
        function setupEventListeners() {
            // Update progress button
            elements.updateProgressBtn.addEventListener('click', updateProgress);
            
            // Calculate total button
            elements.calculateTotalBtn.addEventListener('click', calculateTotal);
            
            // All editable cost inputs
            elements.expenseInputs.forEach(input => {
                input.addEventListener('change', calculateTotal);
            });
            
            // Current savings input
            elements.currentSavings.addEventListener('change', updateProgress);
            
            // Expense category headers (for toggling details)
            document.querySelectorAll('.expense-header').forEach(header => {
                header.addEventListener('click', function() {
                    const details = this.nextElementSibling;
                    details.classList.toggle('show');
                });
            });
        }

        // Calculate the total budget
        async function calculateTotal() {
            if (isLoading) return;
            
            let total = 0;
            const updatedCategories = [];
            
            elements.expenseInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
                
                updatedCategories.push({
                    id: input.id.replace('Cost', ''),
                    budget: value
                });
            });
            
            elements.totalCost.textContent = 'R' + total.toLocaleString('en-ZA');
            elements.targetAmount.value = total;
            
            // Prepare updated data
            const updatedData = {
                ...appData,
                tripDetails: {
                    ...appData.tripDetails,
                    targetAmount: total,
                    currentSavings: parseFloat(elements.currentSavings.value) || 0,
                    lastUpdated: new Date().toISOString()
                },
                expenseCategories: updatedCategories
            };
            
            // Save the updated data
            await saveData(updatedData);
            
            updateProgress();
        }

        // Update the progress bar
        function updateProgress() {
            const current = parseFloat(elements.currentSavings.value) || 0;
            const target = parseFloat(elements.targetAmount.value) || 1;
            const percentage = Math.min(Math.round((current / target) * 100), 100);
            
            elements.progressBar.style.width = percentage + '%';
            elements.progressBar.textContent = percentage + '%';
            
            // Update data if changed
            if (appData.tripDetails.currentSavings !== current) {
                appData.tripDetails.currentSavings = current;
                saveData(appData);
            }
        }

        // Initialize the application
        async function initializeApp() {
            // Load data
            appData = await loadData();
            
            // Update UI with loaded data
            updateUI(appData);
            
            // Set up event listeners
            setupEventListeners();
            
            // Show all sections (initially hidden to prevent flash)
            document.body.style.opacity = 1;
        }

        // Initialize when DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Hide body initially to prevent flash
            document.body.style.opacity = 0;
            
            // Initialize app
            initializeApp();
        });
    </script>
</body>
</html>